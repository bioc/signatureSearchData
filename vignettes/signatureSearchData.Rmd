---
title: _signatureSearchData_ - Annotation data package for signatureSearch
author: "Author: Yuzhu Duan (yduan004@ucr.edu)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
    toc: true
    toc_float:
        collapsed: true
        smooth_scroll: true
    toc_depth: 4
    fig_caption: yes
    code_folding: show
    number_sections: true
  pdf_document:
    toc: true
fontsize: 15pt
vignette: >
  %\VignetteIndexEntry{signatureSearchData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: auto !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>

```{r setup0, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
This is an annotation data package for `signatureSearch` softeware packge. It
stores the CMAP/LINCS reference databases used for GESS methods in the
`signatureSearch` package as well as other intermediate datasets.

# `cmap` signature database
The `cmap` database represents the $log_2$ fold change (log2FC) of 12,437 genes 
from 1,281 compound treatments in 4 cells (3,478 signatures in total). 
It is stored as HDF5 backed `SummarizedExperiment` object and can be loaded 
through the `AnnotationHub` interface
```{r cmap, eval=TRUE}
library(AnnotationHub)
ah <- AnnotationHub()
qr <- query(ah, c("signatureSearchData", "cmap"))
qr
cmap <- load_sigdb("AH69075","AH69076","cmap")
```

## Generate the `cmap` database from the original resources
The resource data was downloaded from the 
[Connectivity Map](https://portals.broadinstitute.org/cmap/) project, 
which is the CEL files generated by Affymetrix chips. 
The downloaded CEL files were normalized by `MAS5` method. 
Then the `limma` package was used to do the differential expression (DE)
analysis to get the `logMA` matrix containing the log2 fold change scores. 
The `logMA` matrix was used to build the HDF5 backed `SummarizedExperiment` 
object, which is the `cmap` database.
The following steps were used to generate the `cmap` database.

### Create expected directory structure
The following creates the expected directory structure. Input data will be 
stored in the data directory and results will be written to the results 
directory. All paths are given relative to the present working directory of 
the userâ€™s R session.
```{r work_envir, eval=FALSE}
dir.create("data"); dir.create("data/CEL"); dir.create("results") 
```

### Download data from Connectivity Map project site
The drug-related expression data are downloaded from the CMAP web site
[here](http://www.broadinstitute.org/cmap). The `getCmapCEL` function
downloads the 7,056 CEL files. The functions will write the
downloaded files to the `data/CEL` directories within the present 
working directory of the user's R session. Since some of the raw data sets 
are large, the functions will only rerun the download if the argument `rerun` 
is assigned `TRUE`. If the raw data are not needed then users can skip this 
time consuming download step and work with the preprocessed data 
obtained in the next section.

```{r download_cmap, eval=FALSE}
getCmapCEL(rerun=FALSE) # Download cmap CEL files. this will take some time
```

The experimental design of the CMAP project is defined in the file
`cmap_instances_02.xls`.  Note, this file required some cleaning in LibreOffice
(Excel would work for this too). After this it was saved as tab delimited txt
file named `cmap_instances_02.txt`. It is stored in this data package.
```{r cmap_inst2, eval=TRUE}
path <- system.file("extdata", "cmap_instances_02.txt", package="signatureSearchData")
cmap_inst <- read.delim(path, check.names=FALSE) 
```

The panel of cell lines used by CMAP includes 
[MCF7](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#mcf7), 
[ssMCF7](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#mcf7), 
[HL60](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#hl60), 
[PC3](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#pc3) and 
[SKMEL5](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#skmel5). 

### Determine chip type from CEL files 
The CMAP data set is based on three different Affymetrix chip types (HG-U133A,
HT_HG-U133A and U133AAofAv2). The following extracts the chip type information
from the CEL files and stores the result in an `rds` file with the path 
`./data/chiptype.rds`. Users who skipped the download of the CEL files can
download this file [here](http://biocluster.ucr.edu/~tgirke/projects/longevity/cmap/data/chiptype.rds).

```{r get_cel_type, eval=FALSE}
celfiles <- list.files("./data/CEL", pattern=".CEL$")
chiptype <- sapply(celfiles, function(x) affxparser::readCelHeader(paste0("data/CEL/", x))$chiptype)
if(FALSE) saveRDS(chiptype, "./data/chiptype.rds") # if(FALSE) protects this line from accidental execution!
```

### Normalization of CEL files

The follwoing processes the CEL files from each chip type separately using the
MAS5 normalization algorithm. The results will be written to 3 subdirectores
under `data` that are named after the chip type names. To save time, the
processing is parallelized with `BiocParallel` to run on 100 CPU cores of a
computer cluster with a scheduler (_e.g._ Torque). The number of CEL files from
each chip type are: 807 CEL files from HG-U133A, 6029 CEL files from
HT_HG-U133A, and 220 CEL files from U133AAofAv2. Note, these numbers are slightly
different than those reported in the `cmap_instances_02.txt` file. 
The MAS5 normalized data sets can be downloaded here: 
[HG-U133A](http://biocluster.ucr.edu/~tgirke/projects/longevity/cmap/data/HG-U133A/all_mas5exprs.rds), 
[HT_HG-U133A](http://biocluster.ucr.edu/~tgirke/projects/longevity/cmap/data/HT_HG-U133A/all_mas5exprs.rds), 
[U133AAofAv2](http://biocluster.ucr.edu/~tgirke/projects/longevity/cmap/data/U133AAofAv2/all_mas5exprs.rds).

```{r normalize_chips, eval=FALSE}
library(BiocParallel); library(BatchJobs); library(affy)
chiptype <- readRDS("./data/chiptype.rds")
chiptype_list <- split(names(chiptype), as.character(chiptype))
normalizeCel(chiptype_list, rerun=FALSE)
```

Combine results from same chip type in single data frame
```{r comb_chip_type_data, eval=FALSE}
chiptype_dir <- unique(readRDS("./data/chiptype.rds"))
combineResults(chiptype_dir, rerun=FALSE)
```

### Clean-up of intermediate files

This deletes intermediate files. Before executing these lines, 
please make sure that this is what you want.

```{r cleanup1, eval=FALSE}
for(i in seq_along(chiptype_dir)) 
    unlink(list.files(paste0("data/", chiptype_dir[i]), pattern="cellbatch", 
                      full.names=TRUE), recursive=TRUE)
unlink("data/CEL/*.CEL") # Deletes downloaded CEL files
```

### Obtain annotation information
The following generates annotation information for the Affymetirx probe set
identifiers. Note, the three different Affymetrix chip types used by CMAP
share most probe set ids (>95%), meaning it is possible to combine the data
after normalization and use the same annotation package for all of them. The
annotation libraries for the chip types HG-U133A and HT_HG-U133A are
`hgu133a.db` and `hthgu133a.db`, respectively. However, there is no annotation 
library (e.g. CDF) available for U133AAofAv2. The annotation file can be downloaded
from here: [`myAnnot.xls`](http://biocluster.ucr.edu/~tgirke/projects/longevity/cmap/results/myAnnot.xls).

```{r affyid_annotations, eval=FALSE, message=FALSE}
library(hgu133a.db)
myAnnot <- data.frame(ACCNUM=sapply(contents(hgu133aACCNUM), paste, collapse=", "), 
                             SYMBOL=sapply(contents(hgu133aSYMBOL), paste, collapse=", "), 
                             UNIGENE=sapply(contents(hgu133aUNIGENE), paste, collapse=", "), 
                             ENTREZID=sapply(contents(hgu133aENTREZID), paste, collapse=", "), 
                             ENSEMBL=sapply(contents(hgu133aENSEMBL), paste, collapse=", "), 
                             DESC=sapply(contents(hgu133aGENENAME), paste, collapse=", "))
write.table(myAnnot, file="./results/myAnnot.xls", quote=FALSE, sep="\t", col.names = NA) 
saveRDS(myAnnot, "./results/myAnnot.rds")
```

### DEG analysis with `limma`

#### Generate list of CEL names defining treatment vs. control comparisons

The `sampleList` function extracts the sample comparisons (contrasts) from the
CMAP annotation table and stores them as a list.

```{r cel_file_list, eval=FALSE}
path <- system.file("extdata", "cmap_instances_02.txt", package="signatureSearchData")
cmap_inst <- read.delim(path, check.names=FALSE) 
comp_list <- sampleList(cmap_inst, myby="CMP_CELL")
```

#### Load normalized expression data 

The following loads the MAS5 normalized expression data into a single `data.frame`. 
To accelerate the import, the data is read from `rds` files. 

```{r load_mas5_data, eval=FALSE}
chiptype_dir <- unique(readRDS("./data/chiptype.rds"))
df1 <- readRDS(paste0("data/", chiptype_dir[1], "/", "all_mas5exprs.rds"))
df2 <- readRDS(paste0("data/", chiptype_dir[2], "/", "all_mas5exprs.rds"))
df3 <- readRDS(paste0("data/", chiptype_dir[3], "/", "all_mas5exprs.rds"))
affyid <- rownames(df1)[rownames(df1) %in% rownames(df2)]; affyid <- affyid[affyid %in% rownames(df3)]
mas5df <- cbind(df1[affyid,], df2[affyid,], df3[affyid,])
```

### Transform probe set to gene level data
The next step generates gene level expression values. If genes are represented by several
probe sets then their mean intensities are used. This is necessary because 
the U133 chip contains many genes with duplicated probe sets. Probe sets not matching 
any gene are removed.

```{r mean_mas5_data, eval=FALSE} 
myAnnot <- readRDS("./results/myAnnot.rds") 
myAnnot <- myAnnot[as.character(myAnnot[,"ENTREZID"]) != "NA",]
mas5df <- mas5df[rownames(myAnnot),]
idlist <- tapply(row.names(myAnnot), as.character(myAnnot$ENTREZID), c)
mas5df <- t(sapply(names(idlist), function(x) colMeans(mas5df[idlist[[x]], ])))
```

### DEG analysis with `limma`

The analysis of differentially expressed genes (DEGs) is performed with the `limma` package.
The log2 fold change (log2FC) scores of drug treatments in cells are used as 
gene expression profiles (GEPs). The log2FC matrix (`logMA`) is stored in the generated [`degList`](http://biocluster.ucr.edu/~yduan004/signatureSearchData/degList.rds).

```{r deg_limma, eval=FALSE}
degList <- runLimma(df=log2(mas5df), comp_list, fdr=0.10, foldchange=1, verbose=TRUE)
saveRDS(degList, "./results/degList.rds") # saves entire degList
```

### Convert the `logMA` into HDF5 backed `SummarizedExperiment` object  
The generated HDF5 backed `SummarizedExperiment` object is the `cmap` database 
storing the log2FC scores of compound treatments in cells.
```{r se, eval=FALSE}
library(SummarizedExperiment)
library(HDF5Array)
degList <- readRDS("./results/degList.rds")
logMA <- degList$logFC
pert_cell_factor = gsub("(^.*)_(.*$)", "\\1__\\2__trt_cp", colnames(logMA))
colData <- DataFrame(pert_cell_factor=pert_cell_factor,
                     pert_cell = colnames(logMA))
new <- as.data.frame(t(sapply(seq_len(nrow(colData)), function(i) 
  unlist(strsplit(as.character(colData$pert_cell[i]), "_")))), 
  stringsAsFactors=FALSE)
colnames(new) = c("pert", "cell")
colData <- cbind(colData, as(new, "DataFrame"))
rownames(colData) = colData$pert_cell_factor
colnames(logMA)=colData$pert_cell_factor # Important to match the treatment format
cmap <- SummarizedExperiment(assays = list(score=logMA), colData = colData)
## Save 'cmap' as an HDF5-based SummarizedExperiment object on disk. 
## Here, it will save to the present working directory of the userâ€™s R session.
cmap <- saveHDF5SummarizedExperiment(cmap, "./cmap")
```

# `cmap_expr` signature database
For correlation based GESS methods in `signatureSearch` package, 
the signature database containing gene 
expression values from drug treatment samples could also be used to search 
for similarity. 

The `cmap_expr` database represents mean expression values of 1,309 drug
treatment samples in 4 cells (3,587 signatures in total).
It is stored as HDF5 backed `SummarizedExperiment` object and can be loaded
through the `AnnotationHub` interface
```{r cmap_expr, eval=FALSE}
library(AnnotationHub)
hub <- AnnotationHub()
myfiles <- query(hub, "SEARCHTERM1", "SEARCHTERM2")
myfiles[[1]]  ## load the first resource in the list
```

The same as the `cmap` database, the resource data was downloaded from the 
[Connectivity Map](https://portals.broadinstitute.org/cmap/) project. 
The expression intensity data was rma normalized. Then, the mean expression 
values of drug treatment samples at different concentration, duration was used
as expression values of that drug in a specific cell. The expression matrix
was saved as HDF5-based SummarizedExperiment object (cmap_expr database).

# `lincs` signature database
The `lincs` database represents moderated z-scores from DE analysis of 12,328 
genes from 8,140 compound treatments in 30 cells (45,956 signatures in total). 
The original LINCS Level 5 moderated z-score database was downloaded at [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92742). 
The downloaded database in `gctx` format was processed and saved as HDF5 backed
`SummarizedExperiment` object and can be loaded through the `AnnotationHub` 
interface
```{r lincs, eval=FALSE}
library(AnnotationHub)
hub <- AnnotationHub()
myfiles <- query(hub, "SEARCHTERM1", "SEARCHTERM2")
myfiles[[1]]  ## load the first resource in the list
```

# `lincs_expr` signature database
The `lincs_expr` database contains mean gene expression values 
from 5,925 compound treatment samples in 30 cells (38,824 signatures in total). 
The original LINCS Level 3 expression database was downloaded at [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92742). 
The downloaded database in `gctx` format was processed and saved as HDF5 backed
`SummarizedExperiment` object and can be loaded through the `AnnotationHub` 
interface
```{r lincs_expr, eval=FALSE}
library(AnnotationHub)
hub <- AnnotationHub()
myfiles <- query(hub, "SEARCHTERM1", "SEARCHTERM2")
myfiles[[1]]  ## load the first resource in the list
```

# Other datasets
This annotation package also contains other intermediate datasets used for
functionalities in the `signatureSearch` software package, 
such as getting targets of query drugs in [DrugBank](https://www.drugbank.ca/), 
[CLUE](https://clue.io/) and [STITCH](http://stitch.embl.de/) databases, 
conducting GO enrichment analysis or computing p-values or Tau scores 
in the results from `gess_lincs` method.

For codes and details of generating the above data, please refer to the [make-data.R](https://github.com/yduan004/signatureSearchData/blob/master/inst/scripts/make-data.R) 
script at [github](https://github.com/yduan004/signatureSearchData).

